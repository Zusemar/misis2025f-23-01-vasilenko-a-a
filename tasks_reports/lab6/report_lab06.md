# Лабораторная работа №6: Векторизация границ объектов

## Цель работы
Реализовать функционал векторизации границ объектов на изображениях, включая нахождение и векторизацию границ объектов интереса, преобразование упрощенной разметки в эталон векторного представления, визуализацию векторного представления объектов интереса, отклонений от эталона и ошибок, а также измерение качества векторизации границ объектов интереса.

---

## Часть 1. Нахождение и векторизация границ объектов интереса

### 1.1 Алгоритм векторизации

Реализована функция:
```cpp
std::vector<VectorizedContour> vectorize_object_boundaries(const cv::Mat& binary_mask,
                                                           double min_area = 100.0,
                                                           double epsilon = 2.0);
```

Функция выполняет следующие шаги:

1. **Нахождение контуров:**
   - Используется функция OpenCV `cv::findContours()` с режимом `RETR_EXTERNAL` (только внешние контуры)
   - Метод аппроксимации: `CHAIN_APPROX_SIMPLE` (упрощение контуров)

2. **Фильтрация по площади:**
   - Контуры с площадью меньше `min_area` отбрасываются
   - Помогает удалить шум и мелкие артефакты

3. **Упрощение контуров:**
   - Используется алгоритм Douglas-Peucker для упрощения контуров
   - Параметр `epsilon` определяет максимальное расстояние от исходного контура до упрощенного
   - Уменьшает количество точек в контуре, сохраняя его форму

4. **Создание векторных контуров:**
   - Для каждого контура создается структура `VectorizedContour`
   - Вычисляются площадь, периметр и bounding box контура

**Параметры:**
- `min_area` — минимальная площадь контура для фильтрации (по умолчанию 100.0)
- `epsilon` — параметр упрощения контура (по умолчанию 2.0 пикселя)

### 1.2 Упрощение контуров (Douglas-Peucker)

Реализована функция:
```cpp
std::vector<cv::Point> simplify_contour(const std::vector<cv::Point>& contour, double epsilon);
```

**Алгоритм Douglas-Peucker:**
- Рекурсивно упрощает контур, удаляя точки, которые находятся близко к прямой линии между двумя другими точками
- Параметр `epsilon` определяет максимальное расстояние от точки до прямой
- Чем больше `epsilon`, тем больше точек удаляется, но форма контура может исказиться

**Преимущества упрощения:**
- Уменьшение объема данных
- Ускорение последующей обработки
- Улучшение визуализации (меньше точек для отрисовки)

### 1.3 Структура VectorizedContour

```cpp
struct VectorizedContour {
    std::vector<cv::Point> points;  // Точки контура
    double area{0.0};                // Площадь контура
    double perimeter{0.0};           // Периметр контура
    cv::Rect bbox;                   // Bounding box контура
    int object_id{0};                // ID объекта (опционально)
};
```

### 1.4 Использование

**Использование:**
```bash
./build/prj.lab/lab06/task06 part1 input_image.png output_dir/
```

**Результаты:**
- `vectorized_contours.png` — визуализация векторизованных контуров
- `vectorized_contours_filled.png` — визуализация с заполнением
- `original.png` — исходное изображение
- `binary_mask.png` — бинарная маска объектов

**Вывод в консоль:**
- Количество векторизованных контуров
- Информация о каждом контуре (количество точек, площадь, периметр)

---

## Часть 2. Изготовление эталона векторного представления

### 2.1 Генерация эталона

Реализована функция:
```cpp
void part2_generate_ground_truth(const std::string& input_path, 
                                 const std::string& output_dir);
```

**Метод создания эталона:**

1. **Комбинация методов бинаризации:**
   - Адаптивная бинаризация (ADAPTIVE_THRESH_GAUSSIAN_C) с параметрами (15, 5)
   - Otsu бинаризация (автоматический порог)
   - Логическое И между результатами (более консервативный подход)

2. **Морфологические операции:**
   - Закрытие (MORPH_CLOSE) для заполнения разрывов
   - Открытие (MORPH_OPEN) для удаления шума
   - Размер ядра: 7×7 (больше, чем для обычной векторизации, для более стабильного эталона)

3. **Векторизация с более строгими параметрами:**
   - `min_area = 100.0` — минимальная площадь контура
   - `epsilon = 1.5` — более точное упрощение (меньше, чем для обычной векторизации)

4. **Сохранение эталона:**
   - Визуализация в формате PNG
   - Векторное представление в текстовом формате

### 2.2 Формат сохранения эталона

**Текстовый формат:**
- Каждая строка — один контур
- Точки контура разделены пробелами
- Каждая точка в формате `x,y`
- Пример: `10,20 30,40 50,60`

**Преимущества текстового формата:**
- Легко редактировать вручную
- Можно использовать в других программах
- Просто парсить и загружать

### 2.3 Использование

**Использование:**
```bash
./build/prj.lab/lab06/task06 part2 input_image.png output_dir/
```

**Результаты:**
- `ground_truth_contours.png` — визуализация эталона
- `ground_truth_contours.txt` — векторное представление эталона
- `ground_truth_contours_filled.png` — визуализация с заполнением

**Примечание:** Эталон можно дополнительно улучшить вручную, отредактировав текстовый файл или используя графические инструменты разметки.

---

## Часть 3. Визуализация векторного представления

### 3.1 Визуализация контуров

Реализована функция:
```cpp
cv::Mat visualize_vectorized_contours(const cv::Mat& img,
                                     const std::vector<VectorizedContour>& contours,
                                     const cv::Scalar& color = cv::Scalar(0, 255, 0),
                                     int thickness = 2,
                                     bool fill = false);
```

**Параметры:**
- `img` — исходное изображение
- `contours` — вектор контуров для визуализации
- `color` — цвет контуров (по умолчанию зеленый)
- `thickness` — толщина линий (по умолчанию 2)
- `fill` — заполнять ли контуры (по умолчанию false)

**Режимы визуализации:**
- **Только контуры** (`fill = false`) — рисуются только границы объектов
- **С заполнением** (`fill = true`) — контуры заполняются цветом

### 3.2 Визуализация ошибок

Реализована функция:
```cpp
cv::Mat visualize_vectorization_errors(const cv::Mat& img,
                                     const std::vector<VectorizedContour>& predicted,
                                     const std::vector<VectorizedContour>& ground_truth,
                                     double distance_threshold = 5.0);
```

**Цветовая кодировка:**
- **Зеленый** — правильно векторизованные контуры (TP)
- **Красный** — ложные контуры (FP)
- **Синий** — пропущенные контуры (FN)

**Алгоритм определения совпадений:**
- Для каждого предсказанного контура ищется ближайший эталонный контур
- Используются метрики: среднее расстояние между контурами и IoU
- Если среднее расстояние ≤ `distance_threshold` и IoU > 0.3, контуры считаются совпадающими

---

## Часть 4. Измерение качества векторизации

### 4.1 Метрики качества

Реализована структура для хранения метрик:
```cpp
struct VectorizationMetrics {
    int TP;  // True Positive
    int FP;  // False Positive
    int FN;  // False Negative
    
    double Precision();
    double Recall();
    double F1();
    
    double MeanHausdorffDistance;  // Среднее расстояние Хаусдорфа
    double MeanContourDistance;    // Среднее расстояние между контурами
    double MeanIoU;                // Средний IoU для контуров
};
```

**Определения:**
- **TP (True Positive)** — правильно векторизованный контур (совпадает с эталоном)
- **FP (False Positive)** — ложный контур (векторизован, но отсутствует в эталоне)
- **FN (False Negative)** — пропущенный контур (есть в эталоне, но не векторизован)

**Метрики:**
- **Precision** = TP / (TP + FP) — точность векторизации
- **Recall** = TP / (TP + FN) — полнота векторизации
- **F1-score** = 2 × (Precision × Recall) / (Precision + Recall) — гармоническое среднее

### 4.2 Метрики расстояния

#### 4.2.1 Расстояние Хаусдорфа

Реализована функция:
```cpp
double hausdorff_distance(const std::vector<cv::Point>& contour1,
                         const std::vector<cv::Point>& contour2);
```

**Определение:**
Расстояние Хаусдорфа — это максимальное расстояние от любой точки одного контура до ближайшей точки другого контура.

**Формула:**
```
H(A, B) = max(h(A, B), h(B, A))
где h(A, B) = max_{a in A} min_{b in B} ||a - b||
```

**Особенности:**
- Учитывает максимальное отклонение между контурами
- Чувствителен к выбросам
- Полезен для оценки максимальной ошибки

#### 4.2.2 Среднее расстояние между контурами

Реализована функция:
```cpp
double average_contour_distance(const std::vector<cv::Point>& contour1,
                                const std::vector<cv::Point>& contour2);
```

**Определение:**
Среднее расстояние между контурами — это среднее значение минимальных расстояний от каждой точки одного контура до ближайшей точки другого контура.

**Особенности:**
- Учитывает все точки контуров
- Менее чувствителен к выбросам, чем расстояние Хаусдорфа
- Полезен для оценки общей точности векторизации

#### 4.2.3 IoU для контуров

Реализована функция:
```cpp
double contour_iou(const std::vector<cv::Point>& contour1,
                  const std::vector<cv::Point>& contour2,
                  const cv::Size& image_size);
```

**Определение:**
IoU (Intersection over Union) для контуров вычисляется как отношение площади пересечения масок контуров к площади их объединения.

**Особенности:**
- Учитывает форму и размер контуров
- Стандартная метрика в задачах сегментации
- Диапазон значений: [0.0, 1.0]

### 4.3 Вычисление метрик

Реализована функция:
```cpp
VectorizationMetrics calc_vectorization_metrics(const std::vector<VectorizedContour>& predicted,
                                                const std::vector<VectorizedContour>& ground_truth,
                                                double distance_threshold = 5.0);
```

**Алгоритм:**
1. Для каждого предсказанного контура ищется ближайший эталонный контур
2. Вычисляются метрики расстояния (Хаусдорф, среднее расстояние, IoU)
3. Если среднее расстояние ≤ `distance_threshold` и IoU > 0.3, контуры считаются совпадающими (TP)
4. Предсказанные контуры без совпадений считаются ложными (FP)
5. Эталонные контуры без совпадений считаются пропущенными (FN)
6. Вычисляются средние метрики для всех TP

**Параметр `distance_threshold`:**
- По умолчанию: 5.0 пикселей
- Можно настроить в зависимости от требований задачи
- Меньшие значения — более строгие критерии совпадения

### 4.4 Использование

**Использование:**
```bash
./build/prj.lab/lab06/task06 part3 input_image.png ground_truth_contours.txt output_dir/
```

**Результаты:**
- `vectorization_metrics.csv` — таблица метрик
- `vectorization_errors.png` — визуализация ошибок
- `predicted_contours.png` — визуализация предсказанных контуров
- `ground_truth_visualized.png` — визуализация эталона

**Формат CSV:**
```
Metric,Value
TP,3
FP,1
FN,0
Precision,0.7500
Recall,1.0000
F1,0.8571
MeanHausdorffDistance,2.3456
MeanContourDistance,1.2345
MeanIoU,0.8234
```

---

## Сборка и использование

### Сборка
```bash
cmake --build /Users/alex/Documents/misis2025f-23-01-vasilenko-a-a/build --config Release -j
```

Исполняемый файл появляется в `build/prj.lab/lab06/task06`.

### Примеры использования

**Часть 1 (Векторизация границ):**
```bash
./build/prj.lab/lab06/task06 part1 walnut01.0130_converted.png output/
```

**Часть 2 (Генерация эталона):**
```bash
./build/prj.lab/lab06/task06 part2 walnut01.0130_converted.png output/
```

**Часть 3 (Оценка качества):**
```bash
./build/prj.lab/lab06/task06 part3 walnut01.0130_converted.png output/ground_truth_contours.txt output/
```

---

## Реализованные функции в библиотеке semcv

### Функции векторизации:
1. `vectorize_object_boundaries()` — нахождение и векторизация границ объектов
2. `simplify_contour()` — упрощение контура алгоритмом Douglas-Peucker
3. `save_vectorized_contours()` — сохранение векторных контуров в текстовый файл
4. `load_vectorized_contours()` — загрузка векторных контуров из текстового файла
5. `visualize_vectorized_contours()` — визуализация векторных контуров
6. `visualize_vectorization_errors()` — визуализация ошибок векторизации

### Функции оценки качества:
1. `calc_vectorization_metrics()` — вычисление метрик векторизации
2. `hausdorff_distance()` — вычисление расстояния Хаусдорфа между контурами
3. `average_contour_distance()` — вычисление среднего расстояния между контурами
4. `contour_iou()` — вычисление IoU для двух контуров
5. `VectorizationMetrics` — структура для хранения метрик

---

## Анализ результатов

### Упрощение контуров

**Преимущества:**
- Уменьшение объема данных
- Ускорение последующей обработки
- Улучшение визуализации

**Недостатки:**
- При слишком большом `epsilon` форма контура может исказиться
- Могут быть потеряны мелкие детали

**Рекомендации:**
- Для эталона использовать меньший `epsilon` (1.0-1.5) для большей точности
- Для обычной векторизации можно использовать больший `epsilon` (2.0-3.0) для упрощения

### Метрики качества

**Преимущества использования нескольких метрик:**
- **Precision/Recall/F1** — общая оценка качества векторизации
- **Hausdorff Distance** — оценка максимальной ошибки
- **Average Contour Distance** — оценка средней ошибки
- **IoU** — оценка совпадения формы и размера

**Интерпретация метрик:**
- **Высокий Precision** — мало ложных контуров
- **Высокий Recall** — мало пропущенных контуров
- **Высокий F1** — баланс между Precision и Recall
- **Низкое Hausdorff Distance** — точная векторизация границ
- **Низкое Average Contour Distance** — хорошее совпадение контуров
- **Высокий Mean IoU** — точное совпадение формы и размера

### Особенности работы с темными изображениями

**Проблемы:**
1. **Низкий контраст** — границы объектов едва различимы
2. **Шум** — может быть ошибочно принят за границы объектов
3. **Разрывы в границах** — контуры могут быть разорваны

**Решения:**
1. **Адаптивная бинаризация** — учитывает локальные особенности изображения
2. **Морфологические операции** — заполнение разрывов и удаление шума
3. **Фильтрация по площади** — удаление слишком маленьких контуров (шум)
4. **Упрощение контуров** — сглаживание неровностей

**Рекомендации:**
- Настройка параметров бинаризации под конкретное изображение
- Использование дополнительных методов улучшения контраста
- Ручная корректировка эталона для более точной оценки качества

---

## Выводы

1. Реализован полный функционал векторизации границ объектов с использованием алгоритма Douglas-Peucker для упрощения контуров
2. Разработан метод автоматической генерации эталона векторного представления с возможностью ручной корректировки
3. Создана система визуализации векторных контуров и ошибок векторизации с цветовой кодировкой
4. Реализована система оценки качества векторизации с использованием метрик Precision, Recall, F1, расстояния Хаусдорфа, среднего расстояния между контурами и IoU
5. Разработаны функции сохранения и загрузки векторных контуров в текстовом формате
6. Проведен анализ особенностей работы с темными изображениями с низким контрастом

**Лабораторная работа №6 выполнена успешно.**


