# Лабораторная работа №5: Детектирование объектов

## Цель работы
Реализовать функционал детектирования объектов на изображениях, включая локализацию объектов интереса, оценку достоверности локализации, анализ на нескольких масштабах, визуализацию результатов и эталона детекций, а также измерение качества детектирования.

---

## Часть 1. Локализация объектов интереса

### 1.1 Многомасштабный анализ

Реализована функция:
```cpp
std::vector<DetectedObject> detect_objects(const cv::Mat& img,
                                           int min_area = 100,
                                           int max_area = 1000000,
                                           const std::vector<double>& scale_factors = {1.0, 0.5, 2.0});
```

Функция выполняет детектирование объектов на нескольких масштабах:
- **Масштабирование изображения** по заданным факторам (например, 0.5, 1.0, 2.0)
- **Адаптивная бинаризация** для выделения объектов на каждом масштабе
- **Морфологические операции** для очистки бинарного изображения
- **Анализ компонент связности** для нахождения связанных регионов
- **Фильтрация по размеру** объектов (min_area, max_area)
- **Масштабирование обратно** к исходному размеру изображения
- **Удаление дубликатов** объектов с большим перекрытием (IoU > 0.5)

**Параметры:**
- `min_area` — минимальная площадь объекта для фильтрации шума
- `max_area` — максимальная площадь объекта
- `scale_factors` — факторы масштабирования для многомасштабного анализа

**Преимущества многомасштабного анализа:**
- Обнаружение объектов разных размеров
- Улучшение детектирования на изображениях с низким контрастом
- Компенсация неточностей бинаризации на разных масштабах

### 1.2 Анализ компонент связности

Используется функция OpenCV `cv::connectedComponentsWithStats()` для:
- Нахождения всех связанных компонент в бинарном изображении
- Получения статистики для каждой компоненты (площадь, bounding box, центр масс)
- Фильтрации компонент по размеру

**Визуализация компонент связности:**
- Каждая компонента раскрашивается случайным цветом
- Позволяет визуально оценить качество бинаризации и выделения объектов

### 1.3 Выбор подходящего масштаба

Алгоритм автоматически анализирует изображение на нескольких масштабах:
- **Масштаб 0.5** — уменьшенное изображение (для больших объектов)
- **Масштаб 0.75** — слегка уменьшенное изображение
- **Масштаб 1.0** — исходный размер (основной масштаб)
- **Масштаб 1.25** — слегка увеличенное изображение
- **Масштаб 1.5** — увеличенное изображение (для мелких объектов)

Использование 5 масштабов обеспечивает более полное покрытие объектов разных размеров.

**Критерии выбора:**
- Объекты детектируются на всех подходящих масштабах
- Дубликаты удаляются по IoU > 0.4, оставляется наиболее достоверный вариант (сортировка по confidence)
- Масштабирование обратно к исходному размеру для единообразия
- Фильтрация по минимальному размеру (5x5 пикселей) и соотношению сторон (0.1-10.0)

### 1.4 Использование

**Использование:**
```bash
./build/prj.lab/lab05/task05 part1 input_image.png output_dir/
```

**Результаты:**
- `detections.png` — визуализация детектированных объектов с bounding boxes (цветовая кодировка по confidence)
- `connected_components.png` — визуализация компонент связности (каждая компонента раскрашена случайным цветом)
- `binary_mask.png` — бинарная маска, использованная для детектирования
- `original.png` — исходное изображение

**Вывод в консоль:**
- Количество детектированных объектов
- Информация о каждом объекте (bbox, confidence)
- Статистика компонент связности (общее количество, количество после фильтрации)
- Анализ достоверности (средняя, минимальная, максимальная confidence)

---

## Часть 2. Оценка достоверности локализации

### 2.1 Метод оценки достоверности

Реализована функция:
```cpp
double estimate_detection_confidence(const cv::Mat& img,
                                    const cv::Rect& bbox,
                                    const cv::Mat& binary_mask);
```

Функция вычисляет confidence score на основе трех факторов:

**1. Контраст объекта (40% веса):**
- Вычисляется разница между средним значением яркости объекта и фона
- Нормализуется к диапазону [0, 1]
- Высокий контраст → высокая достоверность

**2. Отношение площади (30% веса):**
- Отношение площади объекта (по маске) к площади bounding box
- Показывает, насколько плотно объект заполняет свой bounding box
- Высокое отношение → высокая достоверность

**3. Компактность (30% веса):**
- Отношение площади к квадрату периметра: `4π × area / perimeter²`
- Показывает, насколько объект близок к кругу (идеальная форма)
- Высокая компактность → высокая достоверность

**Итоговая формула:**
```
confidence = 0.4 × contrast + 0.3 × area_ratio + 0.3 × compactness
```

**Диапазон значений:** [0.0, 1.0]

### 2.2 Визуализация достоверности

Визуализация использует цветовую кодировку:
- **Зеленый** — высокая достоверность (confidence > 0.7)
- **Желтый** — средняя достоверность (0.4 < confidence ≤ 0.7)
- **Красный** — низкая достоверность (confidence ≤ 0.4)

На каждом bounding box отображается численное значение confidence.

### 2.3 Применение

Оценка достоверности используется для:
- Фильтрации ложных срабатываний (можно установить порог confidence)
- Ранжирования детектированных объектов
- Визуальной оценки качества детектирования

---

## Часть 3. Изготовление эталона детектирования

### 3.1 Генерация эталона

Реализована функция:
```cpp
void part2_generate_ground_truth(const std::string& input_path, 
                                 const std::string& output_dir);
```

**Метод создания эталона:**

1. **Комбинация методов бинаризации:**
   - Адаптивная бинаризация (ADAPTIVE_THRESH_GAUSSIAN_C) с параметрами (15, 5)
   - Otsu бинаризация (автоматический порог)
   - Логическое И между результатами (более консервативный подход)

2. **Морфологические операции:**
   - Закрытие (MORPH_CLOSE) для заполнения разрывов
   - Открытие (MORPH_OPEN) для удаления шума
   - Размер ядра: 7×7 (больше, чем для детектирования, для более стабильного эталона)

3. **Поиск контуров и создание bounding boxes:**
   - Находятся все внешние контуры (RETR_EXTERNAL)
   - Для каждого контура вычисляется bounding box
   - Фильтрация по минимальной площади (100 пикселей)

4. **Назначение достоверности:**
   - Для эталона устанавливается высокая достоверность (0.9)
   - Эталон считается "истинным" детектированием

### 3.2 Сохранение эталона

Эталон сохраняется в двух форматах:

**1. Изображение:**
- `ground_truth_detections.png` — визуализация эталона с зелеными bounding boxes

**2. Текстовый файл (CSV):**
- `ground_truth_detections.txt` — формат: `x,y,width,height,confidence`
- Позволяет загружать эталон для последующего использования
- Можно редактировать вручную для улучшения точности

**Использование:**
```bash
./build/prj.lab/lab05/task05 part2 input_image.png output_dir/
```

**Результаты:**
- `ground_truth_detections.png` — визуализация эталона с зелеными bounding boxes
- `ground_truth_detections.txt` — текстовый файл с координатами и достоверностью
- `ground_truth_mask.png` — бинарная маска, использованная для создания эталона

**Примечание:** Эталон можно дополнительно улучшить вручную, отредактировав текстовый файл или используя графические инструменты разметки. Достоверность для эталона устанавливается не менее 0.85.

---

## Часть 4. Измерение качества детектирования

### 4.1 Метрики качества

Реализована структура для хранения метрик:
```cpp
struct DetectionMetrics {
    int TP;  // True Positive
    int FP;  // False Positive
    int FN;  // False Negative
    
    double Precision();
    double Recall();
    double F1();
    double MeanIoU;
    
    std::vector<double> detection_ious;  // IoU для каждого TP
};
```

**Определения:**
- **TP (True Positive)** — правильно детектированный объект (IoU ≥ threshold)
- **FP (False Positive)** — ложное срабатывание (детектирован объект, которого нет в эталоне)
- **FN (False Negative)** — пропущенный объект (объект есть в эталоне, но не детектирован)

**Метрики:**
- **Precision** = TP / (TP + FP) — точность детектирования
- **Recall** = TP / (TP + FN) — полнота детектирования
- **F1-score** = 2 × (Precision × Recall) / (Precision + Recall) — гармоническое среднее
- **Mean IoU** — средний IoU для правильно детектированных объектов

### 4.2 Вычисление метрик

Реализована функция:
```cpp
DetectionMetrics calc_detection_metrics(const std::vector<DetectedObject>& predicted,
                                       const std::vector<DetectedObject>& ground_truth,
                                       double iou_threshold = 0.5);
```

**Алгоритм:**
1. Для каждого предсказанного объекта ищется ближайший эталонный объект (по IoU)
2. Если IoU ≥ threshold, объект считается правильно детектированным (TP)
3. Предсказанные объекты без совпадений считаются ложными срабатываниями (FP)
4. Эталонные объекты без совпадений считаются пропущенными (FN)
5. Вычисляется средний IoU для всех TP

**Параметр `iou_threshold`:**
- По умолчанию: 0.5 (стандартное значение для детектирования объектов)
- Можно настроить в зависимости от требований задачи

### 4.3 IoU (Intersection over Union)

Реализована функция:
```cpp
double calculate_iou(const cv::Rect& box1, const cv::Rect& box2);
```

**Формула:**
```
IoU = intersection_area / union_area
```

Где:
- `intersection_area` — площадь пересечения двух bounding boxes
- `union_area` — площадь объединения двух bounding boxes

**Диапазон значений:** [0.0, 1.0]
- 0.0 — нет пересечения
- 1.0 — полное совпадение

### 4.4 Визуализация ошибок

Реализована функция:
```cpp
cv::Mat visualize_detection_errors(const cv::Mat& img,
                                 const std::vector<DetectedObject>& predicted,
                                 const std::vector<DetectedObject>& ground_truth,
                                 double iou_threshold = 0.5);
```

**Цветовая кодировка:**
- **Зеленый** — правильно детектированные объекты (TP)
- **Красный** — ложные срабатывания (FP)
- **Синий** — пропущенные объекты (FN)

### 4.5 Использование

**Использование:**
```bash
./build/prj.lab/lab05/task05 part3 input_image.png ground_truth.txt output_dir/
```

**Результаты:**
- `detection_metrics.csv` — таблица метрик (TP, FP, FN, Precision, Recall, F1, MeanIoU)
- `detection_errors.png` — визуализация ошибок с цветовой кодировкой (зеленый=TP, красный=FP, синий=FN)
- `predicted_detections.png` — визуализация предсказанных детекций с цветовой кодировкой по confidence
- `ground_truth_visualized.png` — визуализация эталона (зеленые рамки)
- `combined_detections.png` — комбинированная визуализация (эталон + предсказания)

**Вывод в консоль:**
- Все метрики качества детектирования
- Детальные IoU значения для каждого правильно детектированного объекта (TP)

**Формат CSV:**
```
Metric,Value
TP,3
FP,1
FN,0
Precision,0.7500
Recall,1.0000
F1,0.8571
MeanIoU,0.8234
```

---

## Сборка и использование

### Сборка
```bash
cd build
cmake ..
cmake --build . --config Release -j
```

Исполняемый файл появляется в `build/prj.lab/lab05/task05`.

### Примеры использования

**Часть 1 (Локализация объектов):**
```bash
./build/prj.lab/lab05/task05 part1 input.png output/
```
Выполняет многомасштабный анализ, детектирование объектов, анализ компонент связности и оценку достоверности.

**Часть 2 (Генерация эталона):**
```bash
./build/prj.lab/lab05/task05 part2 input.png output/
```
Создает эталон детектирования на основе комбинации методов бинаризации и сохраняет его в текстовом формате.

**Часть 3 (Оценка качества):**
```bash
./build/prj.lab/lab05/task05 part3 input.png output/ground_truth_detections.txt output/
```
Загружает эталон, выполняет детектирование, вычисляет метрики качества и создает визуализации ошибок.

---

## Реализованные функции в библиотеке semcv

### Функции детектирования:
1. `detect_objects()` — локализация объектов с многомасштабным анализом
2. `estimate_detection_confidence()` — оценка достоверности локализации
3. `visualize_detections()` — визуализация детектированных объектов
4. `visualize_detection_errors()` — визуализация ошибок детектирования

### Функции оценки качества:
1. `calc_detection_metrics()` — вычисление метрик детектирования
2. `calculate_iou()` — вычисление IoU для двух bounding boxes
3. `DetectionMetrics` — структура для хранения метрик

---

## Анализ результатов

### Многомасштабный анализ

**Преимущества:**
- Обнаружение объектов разных размеров
- Улучшение детектирования на изображениях с низким контрастом
- Компенсация неточностей бинаризации на разных масштабах

**Недостатки:**
- Увеличение времени вычислений
- Возможность появления дубликатов (решается фильтрацией)

### Оценка достоверности

**Преимущества:**
- Позволяет ранжировать детектированные объекты
- Помогает фильтровать ложные срабатывания
- Учитывает несколько факторов (контраст, размер, форма)

**Ограничения:**
- Веса факторов выбраны эмпирически
- Может потребоваться настройка для конкретных задач

### Метрики качества

**Преимущества использования IoU:**
- Учитывает как позицию, так и размер объекта
- Стандартная метрика в задачах детектирования объектов
- Позволяет установить порог для определения правильности детектирования

**Интерпретация метрик:**
- **Высокий Precision** — мало ложных срабатываний
- **Высокий Recall** — мало пропущенных объектов
- **Высокий F1** — баланс между Precision и Recall
- **Высокий Mean IoU** — точная локализация объектов

---

## Особенности работы с темными изображениями

### Проблемы:
1. **Низкий контраст** — объекты едва различимы на фоне
2. **Шум** — может быть ошибочно принят за объекты
3. **Слабая граница объектов** — сложно определить точные границы

### Решения:
1. **Адаптивная бинаризация** — учитывает локальные особенности изображения
2. **Морфологические операции** — очистка от шума и заполнение разрывов
3. **Многомасштабный анализ** — улучшение детектирования на разных масштабах
4. **Фильтрация по размеру** — удаление слишком маленьких объектов (шум)
5. **Оценка достоверности** — ранжирование детектированных объектов

### Рекомендации:
- Настройка параметров адаптивной бинаризации под конкретное изображение
- Использование дополнительных методов улучшения контраста (гамма-коррекция, гистограммная эквализация)
- Ручная корректировка эталона для более точной оценки качества

---

## Выводы

1. Реализован полный функционал детектирования объектов с использованием многомасштабного анализа и анализа компонент связности
2. Разработан метод оценки достоверности локализации на основе контраста, размера и формы объектов
3. Создана система визуализации результатов детектирования и ошибок с цветовой кодировкой
4. Реализована система оценки качества детектирования с использованием метрик Precision, Recall, F1 и Mean IoU
5. Разработан метод автоматической генерации эталона детектирования с возможностью ручной корректировки
6. Проведен анализ особенностей работы с темными изображениями с низким контрастом

**Лабораторная работа №5 выполнена успешно.**

