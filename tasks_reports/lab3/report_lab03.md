# Лабораторная работа №3: Бинаризация

## Цель работы
Реализовать функционал глобальной бинаризации изображений, визуализации масок, оценки качества бинаризации с использованием метрик классификации (TP/FP/FN/TN, TPR/FPR, IoU) и провести анализ зависимости качества от порога бинаризации.

---

## Часть 1. Базовая бинаризация

### 1.1 Получение серого одноканального изображения

Реализована функция:
```cpp
cv::Mat to_grayscale(const cv::Mat& img);
```

Функция конвертирует входное изображение в серое одноканальное (CV_8UC1):
- Если изображение уже одноканальное — возвращает копию
- Для 3-канальных изображений использует `cv::COLOR_BGR2GRAY`
- Для 4-канальных (BGRA) использует `cv::COLOR_BGRA2GRAY`
- В остальных случаях берёт первый канал

### 1.2 Построение и визуализация гистограммы

Используется уже реализованная функция из lab02:
```cpp
cv::Mat draw_histogram_8u(const cv::Mat& img,
                         const cv::Scalar& background_color = cv::Scalar(224, 224, 224),
                         const cv::Scalar& bar_color = cv::Scalar(32, 32, 32));
```

Гистограмма визуализируется в квадрате 256×256 пикселей, максимальная высота столбца — 250 пикселей.

### 1.3 Простой алгоритм глобальной бинаризации

Реализована функция:
```cpp
cv::Mat global_threshold(const cv::Mat& gray, double threshold, double maxval = 255.0);
```

Функция выполняет простую пороговую бинаризацию:
- Пиксели со значением > `threshold` → `maxval` (обычно 255)
- Пиксели со значением ≤ `threshold` → 0

Используется стандартная функция OpenCV `cv::threshold()` с флагом `cv::THRESH_BINARY`.

### 1.4 Визуализация маски

Реализована функция:
```cpp
cv::Mat overlay_mask(const cv::Mat& img, const cv::Mat& mask, 
                     const cv::Scalar& mask_color = cv::Scalar(0, 255, 0), 
                     double alpha = 0.5);
```

Функция накладывает полупрозрачную маску на исходное изображение:
1. Конвертирует исходное изображение в цветное (BGR), если оно серое
2. Создаёт цветную маску заданного цвета (по умолчанию зелёная)
3. Накладывает маску с прозрачностью `alpha` (0.0 — полностью прозрачная, 1.0 — непрозрачная)

Используется `cv::addWeighted()` для смешивания изображений.

**Пример использования:**
```bash
./bin.rel/task03 part1 input_image.png output_dir/ 127
```

Результаты сохраняются в `output_dir/`:
- `grayscale.png` — серое изображение
- `histogram.png` — визуализация гистограммы
- `binary_mask.png` — бинарная маска
- `overlay.png` — наложение маски на исходное изображение

---

## Часть 2. Оценка качества бинаризации

### 2.1 Генерация эталонных масок

Для создания эталонных масок реализована функция генерации нескольких вариантов:
- Простая пороговая бинаризация (threshold = 127)
- Метод Оцу (автоматический выбор порога)
- Адаптивная бинаризация

**Использование:**
```bash
./bin.rel/task03 gen_gt input_image.png output_dir/
```

Сгенерированные маски можно редактировать вручную в Paint.net для создания точных эталонных масок.

### 2.2 Метрики оценки качества

Реализована структура для хранения метрик:
```cpp
struct BinaryClassificationMetrics {
    int TP, FP, FN, TN;
    double TPR();      // True Positive Rate (Recall)
    double FPR();      // False Positive Rate
    double Precision();
    double IoU();      // Intersection over Union
    double Accuracy();
};
```

**Определения:**
- **TP (True Positive)** — пиксели, правильно классифицированные как объект
- **FP (False Positive)** — пиксели, ошибочно классифицированные как объект
- **FN (False Negative)** — пиксели объекта, ошибочно классифицированные как фон
- **TN (True Negative)** — пиксели, правильно классифицированные как фон

**Метрики:**
- **TPR (True Positive Rate / Recall)** = TP / (TP + FN) — доля правильно найденных пикселей объекта
- **FPR (False Positive Rate)** = FP / (FP + TN) — доля фоновых пикселей, ошибочно принятых за объект
- **Precision** = TP / (TP + FP) — точность среди пикселей, классифицированных как объект
- **IoU (Intersection over Union)** = TP / (TP + FP + FN) — пересечение над объединением
- **Accuracy** = (TP + TN) / (TP + FP + FN + TN) — общая точность классификации

Реализована функция:
```cpp
BinaryClassificationMetrics calc_binary_metrics(const cv::Mat& predicted_mask, 
                                                 const cv::Mat& ground_truth_mask);
```

### 2.3 Анализ зависимости качества от порога

Реализован анализ зависимости метрик от порога бинаризации:
- Перебираются пороги от 0 до 255 с шагом 5
- Для каждого порога вычисляются все метрики
- Результаты сохраняются в CSV-файл
- Находится оптимальный порог по максимальному IoU

**Использование:**
```bash
./bin.rel/task03 part2 input_image.png ground_truth_mask.png output_dir/
```

Результаты:
- `threshold_analysis.csv` — таблица метрик для всех порогов
- `best_binary.png` — бинаризация с оптимальным порогом
- `best_overlay.png` — визуализация оптимальной маски

**Формат CSV:**
```
threshold,TP,FP,FN,TN,TPR,FPR,Precision,IoU,Accuracy
0,...
5,...
...
```

### 2.4 Анализ ошибок метода глобальной бинаризации

**Основные проблемы глобальной бинаризации:**

1. **Неравномерное освещение** — один порог не подходит для всего изображения
2. **Шум** — случайные пиксели могут быть неправильно классифицированы
3. **Градиенты яркости** — объекты с плавными переходами яркости могут быть частично потеряны
4. **Зависимость от контраста** — метод работает хорошо только при достаточном контрасте между объектом и фоном

**Выводы из анализа:**
- При малых порогах (0-50) — высокий FPR, много ложных срабатываний
- При средних порогах (100-150) — обычно оптимальный баланс для большинства изображений
- При больших порогах (200-255) — высокий FN, объекты теряются

Оптимальный порог зависит от конкретного изображения и должен выбираться на основе метрик качества.

---

## Сборка и использование

### Сборка
```bash
cmake --build /Users/alex/Documents/misis2025f-23-01-vasilenko-a-a/build --config Release -j
```

Исполняемый файл появляется в `bin.rel/task03`.

### Примеры использования

**Часть 1:**
```bash
./bin.rel/task03 part1 input.png output/ 127
```

**Генерация эталонных масок:**
```bash
./bin.rel/task03 gen_gt input.png output/
```

**Часть 2 (оценка качества):**
```bash
./bin.rel/task03 part2 input.png ground_truth.png output/
```

---

## Реализованные функции в библиотеке semcv

1. `to_grayscale()` — конвертация в серое изображение
2. `global_threshold()` — глобальная бинаризация
3. `overlay_mask()` — визуализация маски с прозрачностью
4. `calc_binary_metrics()` — вычисление метрик качества
5. `BinaryClassificationMetrics` — структура для хранения метрик

---

## Выводы

1. Реализован полный функционал бинаризации с визуализацией результатов
2. Создана система оценки качества бинаризации с использованием стандартных метрик классификации
3. Проведён анализ зависимости качества от порога бинаризации
4. Выявлены основные ограничения метода глобальной бинаризации

**Лабораторная работа №3 выполнена успешно.**

